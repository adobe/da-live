import{Schema as P}from"../../da-y-wrapper/dist/index.js";import{addListNodes as q}from"../../da-y-wrapper/dist/index.js";import{tableNodes as K}from"../../da-y-wrapper/dist/index.js";function $(e){return[{tag:e,contentElement:t=>t}]}var y={dataId:{default:null,validate:"string|null"},daDiffAdded:{default:null,validate:"string|null"}},D=e=>{let t={};return e.attrs.dataId!=null&&(t["data-id"]=e.attrs.dataId),e.attrs.daDiffAdded===""&&(t["da-diff-added"]=""),t},M=e=>({dataId:e.getAttribute("dataId")??null,daDiffAdded:e.getAttribute("da-diff-added")??null}),x=e=>t=>({level:e,...M(t)}),U={doc:{content:"block+"},paragraph:{attrs:{...y},content:"inline*",group:"block",parseDOM:[{tag:"p",getAttrs:M}],toDOM(e){return["p",{...D(e)},0]}},blockquote:{attrs:{...y},content:"block+",group:"block",defining:!0,parseDOM:[{tag:"blockquote",getAttrs:M}],toDOM(e){return["blockquote",{...D(e)},0]}},horizontal_rule:{group:"block",parseDOM:[{tag:"hr"}],toDOM(){return["hr"]}},heading:{attrs:{level:{default:1},...y},content:"inline*",group:"block",defining:!0,parseDOM:[{tag:"h1",getAttrs:x(1)},{tag:"h2",getAttrs:x(2)},{tag:"h3",getAttrs:x(3)},{tag:"h4",getAttrs:x(4)},{tag:"h5",getAttrs:x(5)},{tag:"h6",getAttrs:x(6)}],toDOM(e){return[`h${e.attrs.level}`,{...D(e)},0]}},code_block:{attrs:{...y},content:"text*",marks:"",group:"block",code:!0,defining:!0,parseDOM:[{tag:"pre",preserveWhitespace:"full",getAttrs:M}],toDOM(e){return["pre",{...D(e)},["code",0]]}},text:{group:"inline"},image:{inline:!0,attrs:{src:{validate:"string"},alt:{default:null,validate:"string|null"},title:{default:null,validate:"string|null"},href:{default:null,validate:"string|null"},dataFocalX:{default:null,validate:"string|null"},dataFocalY:{default:null,validate:"string|null"},...y},group:"inline",draggable:!0,parseDOM:[{tag:"img[src]",getAttrs(e){let t={src:e.getAttribute("src"),alt:e.getAttribute("alt"),href:e.getAttribute("href"),dataFocalX:e.getAttribute("data-focal-x"),dataFocalY:e.getAttribute("data-focal-y"),...M(e)},a=e.getAttribute("title");return a?.includes("data-focal:")||(t.title=a),t}}],toDOM(e){let{src:t,alt:a,title:r,href:i,dataFocalX:n,dataFocalY:o}=e.attrs,c={src:t,alt:a,title:r,href:i,...D(e)};return n!=null&&(c["data-focal-x"]=n),o!=null&&(c["data-focal-y"]=o),n!=null&&(c.title=`data-focal:${n},${o}`),["img",c]}},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return["br"]}},loc_added:{group:"block",content:"block+",atom:!0,isolating:!0,parseDOM:$("da-loc-added"),toDOM:()=>["da-loc-added",{contenteditable:!1},0]},diff_added:{group:"block",content:"block+",atom:!0,isolating:!0,parseDOM:[{tag:"da-diff-added",contentElement:e=>([...e.children].forEach(t=>{t.properties&&(t.properties["da-diff-added"]="")}),e)}],toDOM:()=>["da-diff-added",{contenteditable:!1},0]},loc_deleted:{group:"block",content:"block+",atom:!0,isolating:!0,parseDOM:$("da-loc-deleted"),toDOM:()=>["da-loc-deleted",{contenteditable:!1},0]},diff_deleted:{group:"block",content:"block+",atom:!0,isolating:!0,parseDOM:[{tag:"da-diff-deleted",contentElement:e=>e}],toDOM:()=>["da-diff-deleted",{"data-mdast":"ignore",contenteditable:!1},0]}},V={link:{attrs:{href:{},title:{default:null},...y},inclusive:!1,parseDOM:[{tag:"a[href]",getAttrs(e){return{href:e.getAttribute("href"),title:e.getAttribute("title"),...M(e)}}}],toDOM(e){let{href:t,title:a}=e.attrs;return["a",{href:t,title:a,...D(e)},0]}},em:{parseDOM:[{tag:"i"},{tag:"em"},{style:"font-style=italic"},{style:"font-style=normal",clearMark:e=>e.type.name==="em"}],toDOM(){return["em",0]}},strong:{parseDOM:[{tag:"strong"},{tag:"b",getAttrs:e=>e.style.fontWeight!=="normal"&&null},{style:"font-weight=400",clearMark:e=>e.type.name==="strong"},{style:"font-weight",getAttrs:e=>/^(bold(er)?|[5-9]\d{2,})$/.test(e)&&null}],toDOM(){return["strong",0]}},code:{parseDOM:[{tag:"code"}],toDOM(){return["code",0]}},s:{parseDOM:[{tag:"s"}],toDOM(){return["s",0]}},u:{parseDOM:[{tag:"u"}],toDOM(){return["u",0]}}},_=new P({nodes:U,marks:V});function J(e){let t={parseDOM:[{tag:"sup"},{clearMark:i=>i.type.name==="sup"}],toDOM(){return["sup",0]}},a={parseDOM:[{tag:"sub"},{clearMark:i=>i.type.name==="sub"}],toDOM(){return["sub",0]}},r={toDOM:()=>["span",{class:"highlighted-context"},0]};return e.addToEnd("sup",t).addToEnd("sub",a).addToEnd("contextHighlightingMark",r)}function Q(){let e=K({tableGroup:"block",cellContent:"block+"});return e.table.attrs={...y},e.table.parseDOM=[{tag:"table",getAttrs:M}],e.table.toDOM=t=>["table",t.attrs,["tbody",0]],e}function L(e,t,a){let r=e;r.get(t).attrs={...y},r.get(t).parseDOM=[{tag:a,getAttrs:M}],r.get(t).toDOM=i=>[a,{...D(i)},0]}function Z(e){let t=q(e,"block+","block");return L(t,"bullet_list","ul"),L(t,"ordered_list","ol"),t}function A(){let{nodes:e}=_.spec,{marks:t}=_.spec;e=Z(e),e=e.update("diff_deleted",{...e.get("diff_deleted"),content:"(block | list_item)+"}),e=e.update("diff_added",{...e.get("diff_added"),content:"(block | list_item)+"}),e=e.update("loc_deleted",{...e.get("loc_deleted"),content:"(block | list_item)+"}),e=e.update("loc_added",{...e.get("loc_added"),content:"(block | list_item)+"}),e=e.append(Q());let a=J(t);return new P({nodes:e,marks:a})}var ee=["div","p","hr","body","header","main","footer","em","strong","s","u","i","b","span","blockquote","picture","source","img","a","h1","h2","h3","h4","h5","h6","pre","code","img","br","ul","ol","li","table","thead","tbody","tr","td","th","sup","sub","da-loc-added","da-loc-deleted","da-diff-added","da-diff-deleted"];function k(e){return ee.includes(e)}import{prosemirrorToYXmlFragment as re,yDocToProsemirror as ae}from"../../da-y-wrapper/dist/index.js";import{DOMParser as ne,DOMSerializer as T}from"../../da-y-wrapper/dist/index.js";var N;typeof DOMParser>"u"&&({fromHtml:N}=await import("hast-util-from-html"));function C(e,t){if(!t||t.type!=="element")return!1;let a=e.match(/^(\w+)\[(\w+)\]$/);if(a){let[,r,i]=a;return t.tagName===r&&t.properties?.[i]!=null}return t.tagName===e.toLowerCase()}function I(e){if(e.nodeType===3)return{type:"text",value:e.textContent};if(e.nodeType===8)return{type:"comment",value:e.textContent};if(e.nodeType===1){let t={};for(let r of e.attributes||[])if(r.name==="class")t.className=r.value.split(/\s+/).filter(Boolean);else if(r.name.startsWith("data-")){let i=r.name.replace(/-([a-z])/g,(n,o)=>o.toUpperCase());t[i]=r.value}else if(r.name==="colspan"||r.name==="rowspan"){let i=r.name==="colspan"?"colSpan":"rowSpan";t[i]=r.value}else t[r.name]=r.value;let a=[];for(let r of e.childNodes||[]){let i=I(r);i&&a.push(i)}return{type:"element",tagName:e.tagName.toLowerCase(),properties:t,children:a}}return null}function te(e){let a=new DOMParser().parseFromString(`<body>${e}</body>`,"text/html"),{body:r}=a;return{type:"root",children:Array.from(r.childNodes).map(I).filter(Boolean)}}function F(e){return N?N(e,{fragment:!0}):te(e)}function ie(e){return e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}function B(e){e&&(e.children&&e.children.forEach(B),e.tagName==="p"&&e.children&&e.children.length===1&&e.children[0].type==="text"&&e.children[0].value==="---"&&(e.children.length=0,e.tagName="hr"))}function j(e){return e.children.filter(t=>t.tagName==="div")}function H(e,t){t.push({type:"element",tagName:"p",children:[],properties:{}});let a=Array.from(e.properties.className),r=a.shift(),i=a.length>0?`${r} (${a.join(", ")})`:r,n=[...j(e)],o=n.reduce((l,f)=>{let u=j(f);return u.length>l?u.length:l},0),c={type:"element",tagName:"table",children:[],properties:{}};c.properties.dataId=e.properties.dataId,c.properties["da-diff-added"]=e.properties["da-diff-added"],t.push(c);let m={type:"element",tagName:"tr",children:[],properties:{}},h={type:"element",tagName:"td",children:[{type:"text",value:i}],properties:{colSpan:o}};m.children.push(h),c.children.push(m),n.filter(l=>l.tagName==="div").forEach(l=>{let f={type:"element",tagName:"tr",children:[],properties:{}},u=(l.children?[...l.children]:[l]).filter(d=>d.type!=="text"||d.value&&d.value.trim()!==`
`&&d.value.trim()!=="");u.forEach((d,b)=>{let s={type:"element",tagName:"td",children:[],properties:{}};u.length<o&&b===u.length-1&&(s.properties.colSpan=o-b),s.children.push(u[b]),f.children.push(s)}),c.children.push(f)}),t.push({type:"element",tagName:"p",children:[],properties:{}})}function W(e){if(!e)return e;if(e.children){let t=[];if(e.children.forEach((a,r)=>{if(a.tagName==="a"&&a.children?.length>0){let{href:i,title:n,"da-diff-added":o}=a.properties,c=!1,m={href:i,title:n,...o===""?{"da-diff-added":o}:{}};a.children.forEach(h=>{h.tagName==="picture"?(c=!0,h.children.forEach(l=>{l.tagName==="img"&&(l.properties={...l.properties,...m})})):h.tagName==="img"&&(c=!0,h.properties={...h.properties,...m})}),c&&t.push({index:r,children:a.children})}else W(a)}),t.length>0){let a=[],r=0;e.children.forEach((i,n)=>{r<t.length&&t[r].index===n?(a.push(...t[r].children),r+=1):a.push(i)}),e.children=a}}return e}function z(e){return e&&(e.children=e.children?.filter(t=>t.type!=="comment")||[],e.children.forEach(z),e)}var R="<body><header></header><main><div></div></main><footer></footer></body>";function le(e){return e=e.replaceAll("<da-loc-added","<da-diff-added").replaceAll("<da-loc-deleted","<da-diff-deleted").replaceAll("</da-loc-added","</da-diff-added").replaceAll("</da-loc-deleted","</da-diff-deleted"),e}var w=e=>({type:"element",tagName:"da-diff-added",properties:{},children:e}),se=e=>e.type==="element"&&e.properties?.["da-diff-added"]!==void 0,de=e=>e.tagName==="div"&&e.properties?.className?.includes("block-group-start"),oe=e=>e.tagName==="div"&&e.properties?.className?.includes("block-group-end"),ce=(e,t)=>{let a=e.findIndex((r,i)=>i>t&&oe(r));return{elementsToWrap:e.slice(t,a===-1?e.length:a+1),endIndex:a===-1?e.length-1:a}};function fe(e){if(!e?.children)return e;let t=[],a=!1;return e.children.forEach(r=>{if(r.tagName==="da-diff-deleted"&&r.children[0]?.tagName==="li"){a=!0;let i=r.children[0];delete r.properties["data-mdast"],delete r.properties.contenteditable,i.children=[{type:"element",tagName:"da-diff-deleted",properties:r.properties,children:i.children}],t.push(i)}else t.push(r)}),a&&(e.children=t),e}function ue(e){return e?.children&&e.children.forEach(t=>{t.tagName==="li"&&t.properties?.["da-diff-added"]!==void 0&&(delete t.properties["da-diff-added"],t.children=[w(t.children)])}),e}function pe(e){e?.children&&e.children.forEach(t=>{if(t.tagName!=="div"||!t.children)return;let a=[...t.children],r=[];for(let i=0;i<a.length;i+=1){let n=a[i];if(se(n))if(de(n)){let{elementsToWrap:o,endIndex:c}=ce(a,i);r.push(w(o)),i=c}else r.push(w([n]));else n.tagName==="ul"||n.tagName==="ol"?r.push(ue(fe(n))):r.push(n)}t.children=r})}var he=e=>{let t={};return e?.children&&e.children.forEach(a=>{if(a.tagName==="div"){let r=a.children?.filter(i=>i.tagName==="div")||[];if(r.length===2){let i=r[0].children?.[0]?.value,n=r[1].children?.[0]?.value||null;i&&(t[i]=n)}}}),t},ge=new Set(["alt","title"]);function X(e){return String(e).replaceAll("&","&#x26;").replaceAll('"',"&#x22;").replaceAll("'","&#x27;")}var E=e=>Object.entries(e).map(([t,a])=>` ${t}="${ge.has(t)?X(a):a}"`).join("");function Y(e,t){if(!e)return e;if(e.type==="element"&&!k(e.tagName)){let a={type:"text",value:`<${e.tagName}${E(e.properties)}>`},r=t.children.indexOf(e);r>=0&&(t.children.splice(r,1,a),t.children.push(...e.children))}return e.children&&[...e.children].forEach(r=>Y(r,e)),e}function me(e,t){e||(e=R),(e.includes("<da-loc-added")||e.includes("<da-loc-deleted"))&&(e=le(e));let a=F(e),r=a.children.find(l=>l.tagName==="div"&&l.properties?.className?.includes("da-metadata")),i=he(r),n=a.children.find(l=>l.tagName==="main");if(n){(e.includes("da-diff-added")||e.includes("da-diff-deleted"))&&pe(n),W(n),z(n),Y(n),(n.children||[]).forEach(u=>{if(u.tagName==="div"&&u.children){let d=[],b=!1;u.children.forEach(s=>{if(s.tagName==="div"&&s.properties.className?.length>0)b=!0,H(s,d);else if(["da-diff-deleted","da-diff-added"].includes(s.tagName)){b=!0;let p=[];s.children.forEach(g=>{g.tagName==="div"&&g.properties.className?.length>0?H(g,p):p.push(g)}),u.children=d,s.children=p,d.push(s)}else d.push(s)}),b&&(u.children=d)}}),B(n);let l=0,f=u=>({type:"element",tagName:u,children:[],properties:{}});n.children=n.children.flatMap(u=>{let d=[];return u.tagName==="div"?(l>0?(d.push(f("p")),d.push(f("hr")),d.push(f("p")),d.push(...u.children)):d.push(u),l+=1):d.push(u),d})}let o={get(l,f){let u=l;if(f==="firstChild"){if(l.children.length===0)return null;for(let d=0;d<l.children.length-1;d+=1)u.children[d].nextSibling=new Proxy(l.children[d+1],o),d>0?u.children[d].previousSibling=new Proxy(l.children[d-1],o):u.children[d].previousSibling=new Proxy(l.children[l.children.length-1],o);return new Proxy(l.children[0],o)}return f==="nodeType"?l.type==="text"?3:1:f==="nodeValue"?l.value:f==="nextSibling"?l.nextSibling:f==="previousSibling"?l.previousSibling:f==="nodeName"?l.tagName?.toUpperCase():f==="matches"?d=>C(d,l):f==="getAttribute"?d=>(d==="colspan"&&(d="colSpan"),d==="rowspan"&&(d="rowSpan"),l.properties?l.properties[d]:void 0):f==="hasAttribute"?d=>l.properties&&l.properties[d]:f==="style"?{}:Reflect.get(l,f)}},c=A(),m=ne.fromSchema(c).parse(new Proxy(n||a,o)),h=t.getMap("daMetadata");Object.entries(i).forEach(([l,f])=>{f!==null?h.set(l,f):h.delete(l)}),re(m,t.getXmlFragment("prosemirror"))}function S(e){let{attributes:t}=e,a=E(t);if(!e.children||e.children.length===0){if(e.type==="text")return ie(e.text);if(e.type==="p")return"";if(e.type==="img"){t.loading||(a+=' loading="lazy"');let{href:n,src:o,title:c}=t;if(t.href){delete t.href,delete t.title;let m=t["da-diff-added"]===""?' da-diff-added=""':"";delete t["da-diff-added"],a=E(t);let h=c?` title="${X(c)}"`:"";return`<a href="${n}"${h}${m}><picture><source srcset="${o}"><source srcset="${o}" media="(min-width: 600px)"><img${a}></picture></a>`}return`<picture><source srcset="${o}"><source srcset="${o}" media="(min-width: 600px)"><img${a}></picture>`}return e.type!=="br"?`<${e.type}${a}></${e.type}>`:`<${e.type}>`}let{children:r}=e;return e.type==="li"&&r.length===1&&r[0].type==="p"&&(r=r[0].children),e.type==="p"&&r.length>0&&r.filter(n=>n.type!=="text"?!0:n.text?.trim().length>0).every(n=>n.type==="img")?r.map(n=>S(n)).join(""):`<${e.type}${a}>${r.map(i=>S(i)).join("")}</${e.type}>`}function be(e){if(!e)return[];let t=[],a=e.lastIndexOf("(");return a>=0?(t.push(e.substring(0,a)),t.push(...e.substring(a+1).split(","))):t.push(e),t.map(r=>r.toLowerCase().replace(/[^0-9a-z]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")).filter(r=>!!r)}function ye(e){if(!e?.children)return e;let t=[],a=!1;return e.children.forEach(r=>{if(r.type==="li"&&r.children[0]?.type==="da-diff-added")a=!0,r.attributes["da-diff-added"]="",r.children=r.children[0].children,r.children.forEach(i=>{i.attributes?.["da-diff-added"]!==void 0&&delete i.attributes["da-diff-added"]}),t.push(r);else if(r.type==="li"&&r.children[0]?.type==="da-diff-deleted"){a=!0;let i={type:"da-diff-deleted",attributes:{"data-mdast":"ignore"},children:[]},n=r.children[0];delete n.attributes.contenteditable,r.children=n.children,i.children.push(r),t.push(i)}else t.push(r)}),a&&(e.children=t),e}function O(e,t){let a=e.children[0].children,r=a.shift(),n={type:"div",attributes:{class:be(r.children[0].children[0].children[0]?.text).join(" ")},children:[]},{dataId:o,daDiffAdded:c}=e.attributes||{};o&&(n.attributes["data-id"]=o),c===""&&(n.attributes["da-diff-added"]=""),t.children.push(n),a.forEach(m=>{let h={type:"div",attributes:{},children:[]};n.children.push(h),m.children.forEach(l=>{h.children.push({type:"div",attributes:{},children:l.children})})})}function Me(e){let t=A(),a=ae(t,e),r=e.getMap("daMetadata"),i={};r.forEach((s,p)=>{i[p]=s}),a=a.type.create({...a.attrs,...i},a.content);let n={type:"div",children:[],attributes:{}},o={get(s,p){let g=s;return p==="createDocumentFragment"?()=>new Proxy(n,o):p==="appendChild"?v=>s.children.push(v):p==="createElement"?v=>new Proxy({type:v,children:[],attributes:[]},o):p==="createTextNode"?v=>new Proxy({type:"text",text:v,attributes:{}},o):p==="setAttribute"?(v,G)=>{g.attributes[v]=G}:Reflect.get(s,p)}},c=T.nodesFromSchema(t),m=T.marksFromSchema(t);delete m.contextHighlightingMark,new T(c,m).serializeFragment(a.content,{document:new Proxy({},o)});let{children:l}=n;n.children=[],l.forEach(s=>{if(s.type==="table")O(s,n);else if(s.type==="ul"||s.type==="ol"){let p=ye(s);n.children.push(p)}else if(s.type==="da-diff-deleted"||s.type==="da-loc-deleted"||s.type==="da-loc-added"){delete s.attributes.contenteditable;let p=s.children;s.children=[],p.forEach(g=>{g.type==="table"?O(g,s):s.children.push(g)}),n.children.push(s)}else s.type==="da-diff-added"?s.children.forEach(g=>{g.type==="table"?O(g,n):n.children.push(g)}):n.children.push(s)});let f={type:"div",attributes:{},children:[]},d=[...n.children].reduce((s,p)=>(p.type==="hr"?s.push({type:"div",attributes:{},children:[]}):s[s.length-1].children.push(p),s),[f]).map(s=>S(s)).join(""),b="";return Object.keys(i).length>0&&(b=`
  <div class="da-metadata">${Object.entries(i).map(([p,g])=>`<div><div>${p}</div><div>${g}</div></div>`).join("")}</div>`),`
<body>
  <header></header>
  <main>${d}</main>
  <footer></footer>${b}
</body>
`}import{prosemirrorToYXmlFragment as Pe,yDocToProsemirror as Ce}from"../../da-y-wrapper/dist/index.js";export{R as EMPTY_DOC,me as aem2doc,Me as doc2aem,A as getSchema,k as isKnownHTMLTag,Pe as prosemirrorToYXmlFragment,O as tableToBlock,Ce as yDocToProsemirror};
